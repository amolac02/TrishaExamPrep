<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Blaster: Arcade Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Press+Start+2P', cursive;
            overflow: hidden;
            background-color: #000;
        }
        /* --- Animated Space Background --- */
        .game-screen {
            background: #000;
            border: 4px solid #7e57c2;
            box-shadow: 0 0 20px #7e57c2, inset 0 0 15px rgba(126, 87, 194, 0.5);
            position: relative;
            overflow: hidden;
            width: 100%;
            max-width: 600px;
            height: 80vh;
            max-height: 800px;
            margin: auto;
        }
        @keyframes move-twink-back {
            from {background-position:0 0;}
            to {background-position:-10000px 5000px;}
        }
        @keyframes move-clouds-back {
            from {background-position:0 0;}
            to {background-position:10000px 0;}
        }
        .stars, .twinkling, .clouds {
            position:absolute; top:0; left:0; right:0; bottom:0;
            width:100%; height:100%; display:block;
        }
        .stars {
            background:#000 url(https://www.script-tutorials.com/demos/360/images/stars.png) repeat top center;
            z-index:0;
        }
        .twinkling{
            background:transparent url(https://www.script-tutorials.com/demos/360/images/twinkling.png) repeat top center;
            z-index:1;
            animation:move-twink-back 200s linear infinite;
        }
        .clouds{
            background:transparent url(https://www.script-tutorials.com/demos/360/images/clouds.png) repeat top center;
            z-index:2;
            opacity: 0.4;
            animation:move-clouds-back 200s linear infinite;
        }
        /* --- Alien & Bomb Elements --- */
        .alien-unit {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            will-change: top;
            z-index: 5;
            animation: hover 3s infinite ease-in-out;
        }
        .alien-ship svg {
            width: 60px;
            height: auto;
        }
        .problem-bomb {
            color: #f0f0f0; background-color: rgba(0,0,0,0.6);
            padding: 8px 12px; border-radius: 8px; border: 2px solid #c53939;
            font-size: 1.25rem; text-shadow: 0 0 5px #ff4f4f;
            margin-top: -5px;
        }
        @media (min-width: 640px) { /* sm breakpoint */
            .problem-bomb { font-size: 1.5rem; }
        }
        @keyframes hover {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        .explosion, .miss-explosion {
            position: absolute; width: 80px; height: 80px;
            background-size: contain; z-index: 6;
        }
        .explosion {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23ffeb3b'/%3E%3Cpath d='M50 5 L55 35 L85 35 L60 55 L70 85 L50 65 L30 85 L40 55 L15 35 L45 35 Z' fill='%23ffc107'/%3E%3C/svg%3E");
            animation: explode 0.3s ease-out forwards;
        }
        .miss-explosion {
             background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23ff5252'/%3E%3Cpath d='M50 5 L55 35 L85 35 L60 55 L70 85 L50 65 L30 85 L40 55 L15 35 L45 35 Z' fill='%23ff1744'/%3E%3C/svg%3E");
             animation: explode 0.4s ease-out forwards;
        }
        @keyframes explode {
            0% { transform: scale(0.5); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        .shield-flash { animation: flash-red 0.4s ease-out; }
        @keyframes flash-red {
            0%, 100% { box-shadow: 0 0 20px #7e57c2, inset 0 0 15px rgba(126, 87, 194, 0.5); }
            50% { box-shadow: 0 0 40px #ff1744, inset 0 0 35px rgba(255, 23, 68, 0.8); }
        }
        .game-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(12, 10, 26, 0.85);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; color: white; z-index: 10;
        }
        .start-button, .retry-button {
            background-color: #ff4081; border: 3px solid #f8bbd0; padding: 15px 30px;
            font-size: 1.2rem; color: white; cursor: pointer; text-shadow: 2px 2px #c51162;
            border-radius: 10px; transition: all 0.2s;
        }
        .start-button:hover, .retry-button:hover { background-color: #f50057; transform: translateY(-3px); }
        .hearts-container { display: flex; gap: 8px; }
        .heart {
            width: 24px; height: 24px; background-color: #ff4081; /* Adjusted heart size */
            position: relative; transform: rotate(-45deg);
        }
        .heart::before, .heart::after {
            content: ""; width: 24px; height: 24px; background-color: #ff4081;
            border-radius: 50%; position: absolute;
        }
        .heart::before { top: -12px; left: 0; } /* Adjusted position */
        .heart::after { top: 0; left: 12px; } /* Adjusted position */
        .slider-container { margin-top: 2rem; width: 80%; }
        .slider-label { font-size: 1rem; margin-bottom: 1rem; text-transform: uppercase; }
        #muteButton { cursor: pointer; transition: transform 0.2s; }
        #muteButton:hover { transform: scale(1.1); }
    </style>
</head>
<body class="bg-black flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl text-white">
        <div class="flex justify-between items-center mb-2">
            <h1 class="text-3xl sm:text-4xl text-center text-indigo-400">Math Blaster</h1>
            <div id="muteButton" title="Toggle Music">
                <svg id="speakerIcon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16"><path d="M11.536 14.01A8.47 8.47 0 0 0 14.026 8a8.47 8.47 0 0 0-2.49-6.01l-.708.707A7.48 7.48 0 0 1 13.025 8c0 2.071-.84 3.946-2.197 5.303z"/><path d="M10.121 12.596A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.48 5.48 0 0 1 11.025 8a5.48 5.48 0 0 1-1.61 3.89z"/><path d="M8.707 11.182A4.5 4.5 0 0 0 10.025 8a4.5 4.5 0 0 0-1.318-3.182L8 5.525A3.5 3.5 0 0 1 9.025 8 3.5 3.5 0 0 1 8 10.475zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06"/></svg>
                <svg id="speakerMutedIcon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="hidden" viewBox="0 0 16 16"><path d="M6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06m7.137 2.096a.5.5 0 0 1 0 .708L12.207 8l1.647 1.646a.5.5 0 0 1-.708.708L11.5 8.707l-1.646 1.647a.5.5 0 0 1-.708-.708L10.793 8 9.146 6.354a.5.5 0 0 1 .708-.708L11.5 7.293l1.646-1.647a.5.5 0 0 1 .708 0"/></svg>
            </div>
        </div>
        <div class="flex justify-between items-center mb-4 text-base sm:text-xl md:text-2xl px-2">
            <div>Score: <span id="score" class="text-green-400">0</span></div>
            <div class="flex items-center gap-2 sm:gap-4">Lives: <div id="livesContainer" class="hearts-container"></div></div>
            <div>High Score: <span id="highScore" class="text-yellow-400">0</span></div>
        </div>

        <div id="gameScreen" class="game-screen">
            <div class="stars"></div>
            <div class="twinkling"></div>
            <div class="clouds"></div>
            <div id="startScreen" class="game-overlay">
                <h2 class="text-5xl mb-8 text-yellow-300">Get Ready!</h2>
                <p class="mb-4 text-lg">Blast the alien ships!</p>
                <button id="startButton" class="start-button">Start Game</button>
                <div class="slider-container">
                    <label for="speedSlider" class="slider-label">Starting Speed: <span id="speedLabel">Normal</span></label>
                    <input type="range" id="speedSlider" min="1" max="5" value="3" class="w-full">
                </div>
            </div>
            <div id="endScreen" class="game-overlay hidden">
                <h2 class="text-5xl mb-4 text-red-500">Game Over</h2>
                <p class="text-2xl mb-8">Final Score: <span id="finalScore" class="text-green-400"></span></p>
                <button id="retryButton" class="retry-button">Play Again</button>
            </div>
        </div>

        <div class="mt-4">
            <input type="number" id="answerInput" class="w-full p-4 bg-gray-700 border-4 border-indigo-400 text-white text-center text-3xl rounded-lg focus:outline-none focus:ring-4 focus:ring-pink-500" placeholder="Type answer here..." autocomplete="off" disabled>
        </div>
    </div>

    <script>
        // DOM Elements
        const gameScreen = document.getElementById('gameScreen'), startScreen = document.getElementById('startScreen'), endScreen = document.getElementById('endScreen');
        const startButton = document.getElementById('startButton'), retryButton = document.getElementById('retryButton');
        const scoreDisplay = document.getElementById('score'), highScoreDisplay = document.getElementById('highScore'), finalScoreDisplay = document.getElementById('finalScore');
        const livesContainer = document.getElementById('livesContainer'), answerInput = document.getElementById('answerInput');
        const speedSlider = document.getElementById('speedSlider'), speedLabel = document.getElementById('speedLabel');
        const muteButton = document.getElementById('muteButton'), speakerIcon = document.getElementById('speakerIcon'), speakerMutedIcon = document.getElementById('speakerMutedIcon');

        // Game State
        let score = 0, lives = 3, problems = [], gameSpeed = 1, problemInterval = 2000;
        let gameLoopId, problemGeneratorId;
        let highScore = localStorage.getItem('mathBlasterHighScore') || 0;
        highScoreDisplay.textContent = highScore;

        // --- Audio Setup (Tone.js) ---
        let audioReady = false;
        const sfx = {
            blast: new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 6, envelope: { attack: 0.001, decay: 0.2, sustain: 0 } }).toDestination(),
            miss: new Tone.NoiseSynth({ noise: { type: 'pink' }, envelope: { attack: 0.01, decay: 0.15, sustain: 0 } }).toDestination()
        };
        const music = {
            synth: new Tone.FMSynth({ harmonicity: 1.5, modulationIndex: 10, envelope: { attack: 0.01, decay: 0.2 }, modulationEnvelope: { attack: 0.01, decay: 0.2 } }).toDestination(),
            loop: null
        };
        music.synth.volume.value = -18;
        music.loop = new Tone.Sequence((time, note) => { music.synth.triggerAttackRelease(note, '16n', time); }, ['C3', 'E3', 'G3', 'B3', 'C4', 'E4', 'G4', 'B4'], '8n');
        Tone.Transport.bpm.value = 160;

        const speedLevels = {
            1: { label: 'Slow', speed: 0.6, interval: 2500 }, 2: { label: 'Easy', speed: 0.8, interval: 2200 },
            3: { label: 'Normal', speed: 1.0, interval: 2000 }, 4: { label: 'Fast', speed: 1.3, interval: 1700 },
            5: { label: 'Insane', speed: 1.6, interval: 1400 },
        };

        function updateSpeedLabel() { speedLabel.textContent = speedLevels[speedSlider.value].label; }
        function createHeart() { const h = document.createElement('div'); h.className = 'heart'; return h; }
        function updateLivesDisplay() { livesContainer.innerHTML = ''; for (let i = 0; i < lives; i++) livesContainer.appendChild(createHeart()); }

        function startGame() {
            if (!audioReady) return;
            const level = speedLevels[speedSlider.value];
            gameSpeed = level.speed; problemInterval = level.interval;
            score = 0; lives = 3;
            problems.forEach(p => p.element.remove()); problems = [];
            scoreDisplay.textContent = score; updateLivesDisplay();
            startScreen.classList.add('hidden'); endScreen.classList.add('hidden');
            answerInput.disabled = false; answerInput.value = ''; answerInput.focus();
            gameLoopId = requestAnimationFrame(gameLoop);
            clearInterval(problemGeneratorId);
            problemGeneratorId = setInterval(createProblem, problemInterval);
            Tone.Transport.start(); music.loop.start(0);
        }

        function endGame() {
            cancelAnimationFrame(gameLoopId); clearInterval(problemGeneratorId);
            if (score > highScore) { highScore = score; localStorage.setItem('mathBlasterHighScore', highScore); highScoreDisplay.textContent = highScore; }
            finalScoreDisplay.textContent = score; endScreen.classList.remove('hidden'); answerInput.disabled = true;
            Tone.Transport.stop(); music.loop.stop(0);
        }

        function gameLoop() {
            if (lives <= 0) return;
            problems.forEach((problem, index) => {
                problem.y += gameSpeed; problem.element.style.top = `${problem.y}px`;
                if (problem.y > gameScreen.clientHeight) {
                    loseLife(problem.element); problem.element.remove(); problems.splice(index, 1);
                }
            });
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        function createProblem() {
            const num1 = Math.floor(Math.random() * 9) + 2, num2 = Math.floor(Math.random() * 9) + 2, answer = num1 * num2;
            
            const alienUnit = document.createElement('div');
            alienUnit.className = 'alien-unit';
            
            // Using innerHTML to create the complex SVG and bomb structure
            alienUnit.innerHTML = `
                <div class="alien-ship">
                    <svg viewBox="0 0 100 75" xmlns="http://www.w3.org/2000/svg">
                        <g fill="#a78bfa">
                            <path d="M50 0 L70 20 L85 25 L95 40 L85 55 L70 60 L50 75 L30 60 L15 55 L5 40 L15 25 L30 20 Z" fill="#4c1d95"/>
                            <path d="M50 10 L65 25 L75 30 L85 40 L75 50 L65 55 L50 65 L35 55 L25 50 L15 40 L25 30 L35 25 Z" fill="#7c3aed"/>
                            <circle cx="50" cy="38" r="12" fill="#c4b5fd"/>
                            <circle cx="50" cy="38" r="6" fill="#312e81"/>
                        </g>
                    </svg>
                </div>
                <div class="problem-bomb">${num1} × ${num2}</div>
            `;
            
            const maxLeft = gameScreen.clientWidth - 80;
            alienUnit.style.left = `${Math.random() * (maxLeft > 0 ? maxLeft : 0)}px`;
            alienUnit.style.top = '-100px'; // Start higher up
            
            gameScreen.appendChild(alienUnit);
            problems.push({ element: alienUnit, answer: answer, y: -100 });
        }

        function loseLife(missedProblemElement) {
            lives--; updateLivesDisplay();
            sfx.miss.triggerAttackRelease("8n");
            gameScreen.classList.add('shield-flash'); setTimeout(() => gameScreen.classList.remove('shield-flash'), 400);
            const missExplosion = document.createElement('div');
            missExplosion.className = 'miss-explosion';
            missExplosion.style.left = `${missedProblemElement.offsetLeft}px`;
            missExplosion.style.top = `${gameScreen.clientHeight - 80}px`;
            gameScreen.appendChild(missExplosion); setTimeout(() => missExplosion.remove(), 400);
            if (lives <= 0) endGame();
        }

        function createExplosion(problemElement) {
            sfx.blast.triggerAttackRelease("C2", "8n");
            const rect = problemElement.getBoundingClientRect(), gameRect = gameScreen.getBoundingClientRect();
            const e = document.createElement('div'); e.className = 'explosion';
            // Target the ship part of the unit for the explosion
            e.style.left = `${rect.left - gameRect.left}px`;
            e.style.top = `${rect.top - gameRect.top}px`;
            gameScreen.appendChild(e); setTimeout(() => e.remove(), 300);
        }

        function checkAnswerOnInput() {
            if (!answerInput.value) return;
            const userAnswer = parseInt(answerInput.value, 10);
            for (let i = problems.length - 1; i >= 0; i--) {
                if (problems[i].answer === userAnswer) {
                    createExplosion(problems[i].element); problems[i].element.remove(); problems.splice(i, 1);
                    score++; scoreDisplay.textContent = score; gameSpeed += 0.01;
                    answerInput.value = ''; return;
                }
            }
        }

        function handleWrongAnswerReset(event) {
            if (event.key !== 'Enter' || !answerInput.value) return;
            if (!problems.some(p => p.answer === parseInt(answerInput.value, 10))) answerInput.value = '';
        }

        async function initializeAudio() {
            await Tone.start(); audioReady = true; console.log("Audio is ready!");
        }
        startButton.addEventListener('click', () => {
             if (!audioReady) { initializeAudio().then(startGame); } else { startGame(); }
        });
        retryButton.addEventListener('click', startGame);
        answerInput.addEventListener('input', checkAnswerOnInput);
        answerInput.addEventListener('keydown', handleWrongAnswerReset);
        speedSlider.addEventListener('input', updateSpeedLabel);
        muteButton.addEventListener('click', () => {
            Tone.Destination.mute = !Tone.Destination.mute;
            speakerIcon.classList.toggle('hidden'); speakerMutedIcon.classList.toggle('hidden');
        });

        updateLivesDisplay();
        updateSpeedLabel();
    </script>
</body>
</html>

