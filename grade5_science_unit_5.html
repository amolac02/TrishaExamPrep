<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Unit 5 Test Generator (25 Random MCQs) + Score Checker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --ok:#2e7d32; --bad:#c62828; --muted:#666; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:20px; line-height:1.45}
    header{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:10px}
    button{padding:8px 14px; border:1px solid #ccc; border-radius:10px; cursor:pointer; background:#f7f7f7}
    button:hover{background:#eee}
    .badge{display:inline-block; font-size:0.8rem; padding:2px 8px; border-radius:999px; background:#eef; color:#334}
    .controls{display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 16px}
    .q{padding:14px 16px; border:1px solid #e2e2e2; border-radius:12px; margin:12px 0}
    .topic{font-size:0.85rem; color:var(--muted)}
    .options{margin-top:8px}
    .options label{display:block; margin:6px 0; cursor:pointer}
    .key{background:#fafafa; border:1px dashed #ccc; padding:10px; border-radius:10px; margin-top:10px; display:none}
    .result{margin-top:16px; padding:12px; border:1px solid #e2e2e2; border-radius:12px}
    .score-big{font-size:1.1rem; font-weight:700}
    .good{color:var(--ok)} .bad{color:var(--bad)}
    .explain{font-size:0.9rem; color:var(--muted)}
    .correct { outline:2px solid var(--ok); border-radius:6px; padding:2px 4px }
    .incorrect { outline:2px solid var(--bad); border-radius:6px; padding:2px 4px }
    .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:8px; margin-top:8px}
    .pill{border:1px solid #ddd; border-radius:999px; padding:6px 10px; font-size:0.85rem}
    .hide{display:none}
  </style>
</head>
<body>
  <header>
    <h1>Unit 5 – Forces & Electricity: Random 25 MCQ Test</h1>
    <div class="badge" id="count">Loading…</div>
  </header>

  <section class="controls">
    <button id="generateBtn" title="Pick a fresh set of 25">Generate 25</button>
    <button id="toggleKeyBtn" title="Show/Hide the answer key under each question">Show/Hide Answer Key</button>
    <button id="checkBtn" title="Grade your selected answers">Check Score</button>
    <button id="resetBtn" title="Clear selected answers only">Reset Answers</button>
    <button onclick="window.print()" title="Print or save as PDF">Print / Save PDF</button>
  </section>

  <div id="paper"></div>

  <div id="results" class="result hide">
    <div class="score-big">Score: <span id="scoreText">0 / 25</span> • <span id="percentText">0%</span></div>
    <div class="grid" id="topicBreakdown"></div>
    <div class="explain" id="tips"></div>
  </div>

  <script>
    const QB_URL = './unit5_question_bank.json';

    function shuffle(arr){
      for(let i=arr.length-1; i>0; i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
    const letter = idx => String.fromCharCode(65 + idx); // 0->A

    function el(tag, attrs={}, html=''){
      const e = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v]) => e.setAttribute(k,v));
      e.innerHTML = html;
      return e;
    }

    function renderTest(questions){
      const container = document.getElementById('paper');
      container.innerHTML = '';
      questions.forEach((q, i) => {
        const block = el('div', {class:'q', 'data-qid': q.id});
        block.innerHTML = `
          <div class="topic">${q.topic} · Difficulty: ${q.difficulty}</div>
          <h3>${i+1}. ${q.question}</h3>
          <div class="options">
            ${q.options.map((opt, k) => `
              <label class="opt" data-k="${k}">
                <input type="radio" name="q${i}" value="${k}">
                ${letter(k)}. ${opt}
              </label>
            `).join('')}
          </div>
          <div class="key"><strong>Answer:</strong> ${letter(q.answer_index)}</div>
        `;
        container.appendChild(block);
      });
      document.getElementById('count').textContent = `Showing ${questions.length} questions`;
      // clear old results
      document.getElementById('results').classList.add('hide');
    }

    function getSelections(){
      const nodes = [...document.querySelectorAll('[name^="q"]')];
      const map = new Map();
      nodes.forEach(inp => {
        if(inp.checked){
          const idx = parseInt(inp.name.replace('q',''),10);
          map.set(idx, parseInt(inp.value,10));
        }
      });
      return map; // idx -> chosenIndex
    }

    function grade(current){
      // Remove previous marking
      document.querySelectorAll('.opt').forEach(o=>{
        o.classList.remove('correct','incorrect');
        o.style.background='transparent';
      });

      let correct = 0;
      const topicStats = {}; // topic -> {correct,total}
      current.forEach((q, i) => {
        const chosen = (getSelections().has(i)) ? getSelections().get(i) : null;
        const block = document.querySelectorAll('.q')[i];
        const labels = block.querySelectorAll('.opt');

        // Tally topic totals
        topicStats[q.topic] ??= {correct:0, total:0};
        topicStats[q.topic].total += 1;

        if(chosen === q.answer_index){
          correct++;
          labels[chosen].classList.add('correct');
        } else {
          if(chosen !== null) labels[chosen].classList.add('incorrect');
          labels[q.answer_index].classList.add('correct');
        }
      });

      // Results UI
      const res = document.getElementById('results');
      const pct = Math.round((correct / current.length) * 100);
      document.getElementById('scoreText').textContent = `${correct} / ${current.length}`;
      document.getElementById('percentText').textContent = `${pct}%`;
      const tb = document.getElementById('topicBreakdown');
      tb.innerHTML = '';
      Object.entries(topicStats).forEach(([topic, {correct:c,total:t}])=>{
        const pill = el('div', {class:'pill'}, `<strong>${topic}:</strong> ${c}/${t} (${Math.round(100*c/t)}%)`);
        tb.appendChild(pill);
      });
      const tips = document.getElementById('tips');
      tips.textContent = pct === 100
        ? 'Perfect! Try Generate 25 for a new set.'
        : 'Tip: Expand the Answer Key to review the ones you missed, then Reset Answers and try again.';
      res.classList.remove('hide');
    }

    function toggleKeys(){
      document.querySelectorAll('.key').forEach(div => {
        div.style.display = (div.style.display === 'block') ? 'none' : 'block';
      });
    }

    function resetAnswers(){
      document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
      document.getElementById('results').classList.add('hide');
      document.querySelectorAll('.opt').forEach(o=>{
        o.classList.remove('correct','incorrect');
        o.style.background='transparent';
      });
    }

    let BANK = [];
    let CURRENT_25 = [];

    async function loadBank(){
      const resp = await fetch(QB_URL);
      if(!resp.ok) throw new Error('Failed to load question bank');
      BANK = await resp.json();
    }

    function pickRandom25(){
      const pool = shuffle([...BANK]);
      return pool.slice(0, 25);
    }

    // Events
    document.getElementById('generateBtn').addEventListener('click', async () => {
      if(BANK.length === 0){
        try { await loadBank(); } catch (e) { alert(e.message); return; }
      }
      CURRENT_25 = pickRandom25();
      renderTest(CURRENT_25);
    });

    document.getElementById('toggleKeyBtn').addEventListener('click', toggleKeys);
    document.getElementById('checkBtn').addEventListener('click', () => {
      if(CURRENT_25.length === 0){ alert('Click "Generate 25" first.'); return; }
      grade(CURRENT_25);
    });
    document.getElementById('resetBtn').addEventListener('click', resetAnswers);

    // Auto-generate on first load
    (async () => {
      try { await loadBank(); } catch(e){ document.getElementById('count').textContent='Question bank not found'; return; }
      CURRENT_25 = pickRandom25();
      renderTest(CURRENT_25);
    })();
  </script>
</body>
</html>
